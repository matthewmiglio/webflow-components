<div
  id="plinkoPopup"
  style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: transparent;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  "
>
  <div
    id="plinkoWrapper"
    style="
      background: #fff;
      padding: 20px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 480px;
      width: 90vw;
    "
  >
    <img
      src="https://cdn.prod.website-files.com/67eb053f349675aae967d272/67eeaecdad26ce80e722789a_logo.png"
      alt="Logo"
      style="
        width: 100%;
        height: auto;
        margin-bottom: 16px;
        object-fit: contain;
      "
    />

    <canvas id="plinkoCanvas" width="400" height="600"></canvas>
    <div
      style="
        margin-top: 16px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
      "
    >
      <button
        id="claimPrizeBtn"
        disabled
        style="
          background: #999;
          color: #fff;
          border: none;
          padding: 10px 18px;
          border-radius: 6px;
          font-weight: 600;
          cursor: not-allowed;
          transition: 0.3s;
        "
      >
        Claim Prize
      </button>

      <button
        onclick="closePlinko()"
        style="
          background: #666;
          color: #fff;
          border: none;
          padding: 10px 18px;
          border-radius: 6px;
          font-weight: 500;
          cursor: pointer;
          transition: 0.2s;
        "
      >
        Close
      </button>
    </div>
    <div
      id="resultText"
      style="margin-top: 14px; color: #111; font-weight: 500"
    ></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

<script>
  let engine,
    render,
    runner,
    world,
    ball,
    bins = [],
    canvasWidth = 400,
    canvasHeight = 600;

  setTimeout(() => {
    document.getElementById("plinkoPopup").style.display = "flex";
    startPlinko();
  }, 0);

  function closePlinko() {
    document.getElementById("plinkoPopup").style.display = "none";
    Matter.Render.stop(render);
    Matter.Runner.stop(runner);
  }

  function replayPlinko() {
    closePlinko();
    setTimeout(() => {
      document.getElementById("plinkoPopup").style.display = "flex";
      startPlinko();
    }, 300);
  }

  function startPlinko() {
    const { Engine, Render, Runner, World, Bodies, Events } = Matter;

    engine = Engine.create();
    engine.gravity.scale = 0.0002; // <- very slow
    // ← this line controls fall speed

    world = engine.world;

    const canvas = document.getElementById("plinkoCanvas");
    const ctx = canvas.getContext("2d");

    render = Render.create({
      canvas,
      engine,
      options: {
        width: canvasWidth,
        height: canvasHeight,
        wireframes: false,
        background: "linear-gradient(180deg, #000000 0%, #00c6ff 100%)", // ← updated!
      },
    });

    const claimBtn = document.getElementById("claimPrizeBtn");
    claimBtn.disabled = true;
    claimBtn.style.background = "#999";
    claimBtn.style.cursor = "not-allowed";

    Render.run(render);
    runner = Runner.create();
    Runner.run(runner, engine);

    const wallOptions = { isStatic: true, render: { fillStyle: "#111" } };
    World.add(world, [
      Bodies.rectangle(canvasWidth / 2, 0, canvasWidth, 5, wallOptions),
    ]);

    const binCount = 9;
    const binWidth = canvasWidth / binCount;

    const binColors = [
      "#1f1f1f", // Charcoal
      "#2b2d42", // Midnight Indigo
      "#3a506b", // Steel Blue
      "#5bc0be", // Teal Cyan
      "#6fffe9", // Neon Aqua
      "#4ecdc4", // Mint Green
      "#3f88c5", // Soft Blue
      "#8338ec", // Electric Purple
      "#ff006e", // Hot Pink Accent
    ];

    const binLabels = [
      "x0.5",
      "x1",
      "x1.5",
      "x2",
      "x3",
      "x2",
      "x1.5",
      "x1",
      "x0.5",
    ];

    bins = [];
    for (let i = 0; i <= binCount; i++) {
      const x = i * binWidth;
      const bin = Bodies.rectangle(x, canvasHeight - 40, 10, 80, {
        isStatic: true,
        render: { fillStyle: binColors[i % binColors.length] },
      });
      bins.push(bin);
      World.add(world, bin);
    }

    const pegOffsetX = 25;
    for (let row = 0; row < 6; row++) {
      for (let col = 0; col < 8; col++) {
        const offset = row % 2 === 0 ? pegOffsetX : 0;
        const x = 50 * col + offset;
        if (x > 20 && x < canvasWidth - 20) {
          const peg = Bodies.circle(x, 100 + row * 60, 1, {
            isStatic: true,
            render: {
              fillStyle: "#bbb",
              strokeStyle: "#999",
              lineWidth: 1,
            },
          });
          World.add(world, peg);
        }
      }
    }

    ball = Bodies.circle(getRandomX(), 30, 12, {
      restitution: 0.6,
      render: { fillStyle: "#f00" },
    });
    World.add(world, ball);

    let claimed = false;

    Events.on(engine, "afterUpdate", function () {
      if (!claimed && ball.position.y > canvasHeight - 60) {
        claimed = true;
        const binIndex = Math.floor(ball.position.x / binWidth);
        document.getElementById(
          "resultText"
        ).textContent = `You landed in bin #${binIndex + 1}!`;

        claimBtn.disabled = false;
        claimBtn.style.background = "#28a745";
        claimBtn.style.cursor = "pointer";
      }
    });

    Events.on(render, "afterRender", () => {
      ctx.save();
      ctx.font = "bold 12px sans-serif";
      ctx.textAlign = "center";
      ctx.fillStyle = "#000";

      for (let i = 0; i < binCount; i++) {
        const label = binLabels[i % binLabels.length];
        const x = i * binWidth + binWidth / 2;
        ctx.fillText(label, x, canvasHeight - 5);
      }

      ctx.restore();
    });

    function getRandomX() {
      let x;
      do {
        x = Math.floor(Math.random() * (360 - 40 + 1)) + 40;
      } while (x > 180 && x < 220);
      return x;
    }
  }

  document.getElementById("claimPrizeBtn").addEventListener("click", () => {
    if (!document.getElementById("claimPrizeBtn").disabled) {
      alert("Prize claimed! 🎉");
      // Optionally call replayPlinko() or trigger reward logic
    }
  });
</script>
